<!-- begin header -->
<header id="header" class="width_fill">
  <!-- begin curtain -->
  <transition name='fading'>
    <div v-if="!isPageLoaded" class="curtain" role="presentation">
      <svg aria-live="assertive" role="alert" aria-label="Загрузка страницы" height="1em" width="1em" viewbox="0 0 44 44">
        <use xlink:href="#pagePreloader" />
      </svg>
    </div>
  </transition>
  <!-- end curtain -->

  <!-- begin headerContainer -->
  <div class="headerContainer height_fill v-centered container parent row wrap h-between">
    <site-navigation class-name="baseChild" logo-color-name="paleBlue" label="Навигация по сайту">
    </site-navigation>
    <!-- Для экранных читалок -->
    <div hidden="" id="currentPage">
      Активная страница
    </div>
    <!-- begin siteMeta -->
    <div class="siteMeta parent row nowrap h-between baseChild font-size_12 index_big">
      <div class="siteMeta__time color-paleGray relative">
        <base-button id="openOrCloseTimezoneButton" :action="switchTimezonesListState" :label="`${isTimezonesShown ? 'Закрыть' : 'Открыть'} выбор временной зоны`"
          unstyled="">
          <time :datetime="accessibleTime" aria-label="Ткущее время" class="margin-right_quarter">
            [[ currentTime ]]
          </time>

          <chevron-icon :position="isTimezonesShown ? 'up' : 'down'" aria-labeledby="openOrCloseTimezoneButton">
          </chevron-icon>
        </base-button>

        <transition appear="" name="fadeTranslateToBottom">
          <ul :aria-expanded="isTimezonesShown" aria-label="Список временых зон" class="absolute font-size_18 popupList popupList_timezones"
            role="navigation" v-if="isTimezonesShown">
            <li v-for="(timezone, index) in [
                    {name: 'MSK', tz: 'Europe/Moscow'},
                    {name: 'Magadan', tz: 'Asia/Magadan'}
                  ]" :key="index">

              <base-button :label="timezone.tz" :action="chooseTimezone(timezone.tz)" class-name="text_left" unstyled>
                [[ timezone.name ]]
              </base-button>
            </li>
          </ul>
        </transition>

      </div>


      <div class="relative siteMetaLanguages font-family_main parent centered">
        <base-button :action="switchLanguageState" id="openOrCloseLanguagesButton" label="Показать открыть выбор языка" unstyled="">
          [[ currentLanguage ]]
          <chevron-icon :position="isLanguagesShown ? 'up' : 'down'" aria-labeledby="openOrCloseLanguagesButton">
          </chevron-icon>
        </base-button>

        <transition appear="" name="fadeTranslateToBottom">
          <ul :aria-expanded="isLanguagesShown" role="navigation" aria-label="Навигация по страницам с разным переводом" class="absolute siteMetaLanguages__list font-size_18 popupList popupList_centered"
            role="navigation" v-if="isLanguagesShown">
            <li :key="index" v-for="(language, index) in [ { name: 'RU', label: 'Русский' }, { name: 'EN', label: 'Английский' } ]">
              <a :aria-label="language.label + 'перевод'" href="/" @click="chooseLanguage(language.name)()">
                [[ language.name ]]
              </a>
            </li>
          </ul>
        </transition>
      </div>
    </div>
    <!-- end siteMeta -->
    <transition name="fading">
      <!-- begin userPanel -->
      <div v-if="$store.state.personalRoom.user.isLogged" class="parent h-end row nowrap userPanel baseChild v-centered">
        <div class="userPanel__balance font-size_18 font-weight_semibold">
          &dollar; [[ $store.state.personalRoom.user.balance ]]
        </div>
        <button-icon :action="openPersonalRoom" :is-awesome-icon="false" class-name="userButton color_white" modifier="blue">
          <lazy-image :src="userIcon" class-name="userButton__icon" relative="">
          </lazy-image>
        </button-icon>
      </div>
      <!-- end userPanel -->
      <!-- begin userPanel -->
      <div v-else class="parent row nowrap userPanel baseChild h-between v-centered font-size_10 margin-left_large h-end_tablet margin-left_zero-phone">
        <base-button :action="openAuthPopup('login')" class-name="margin-right_base-tablet" modifier="blue">
          Войти
        </base-button>
        <base-button :action="openAuthPopup('registration')" modifier="blue">
          Регистрация
        </base-button>
      </div>
      <!-- end userPanel -->
    </transition>

  </div>
  <user-authorization :submit-recover-password="() => {
          log(recoverPassword);

          const formName = formsNames.recoverPassword;
          const requestOptions = {
            headers: {
              'X-CSRF-Token': $store.state.csrftoken
            }
          };

          $store.commit('authorization/switchRequestingState', true);

          // const request = axios(requestOptions);

          const request = window.Promise.resolve({
            status: 'ok',
            errorMessage: 'Мы не нашли аккаунт с таким email адресом.'
          });

          window.setTimeout(() => {
            request.then(response => {
            const isError =  response.status !== 'ok';

              const message = response.message;
              const responseOptions = {
                message: isError ? response.errorMessage : `Мы выслали письмо с инструкциями по восстановлению пароля на вашу почту ${recoverPassword.email}.`,
                isError,
                formName
              };

              $store.dispatch(
                'authorization/showResponseMessage',
                responseOptions
              );
            });
          }, 1500);
        }" :submit-login="() => {
          log(login);

          const formName = formsNames.login;

          if (!login.username && !login.password) {
            return false;
          };

          const requestOptions = {
            headers: {
              'X-CSRF-Token': $store.state.csrftoken
            }
          };

          $store.commit('authorization/switchRequestingState', true);

          // const request = axios(requestOptions);

          const request = window.Promise.resolve({
            status: 'ok',
            userData: {
              balance: 9999.99,
              name: login.username,
              avatar: '/images/personalRoom/avatar.jpg',
              id: 139452,
              password: login.password
            },
            isLogged: true
          });

          window.setTimeout(() => {
            request.then(response => {
             const isError = response.status !== 'ok';
              const responseOptions = {
                userData: {
                  ...response.userData
                },
                errorMessage: isError ? 'Что-то пошло не так.' : '',
                isError,
                formName
              };

              $store.dispatch(
                'authorization/showUserDataIfUserLogged',
                responseOptions
              );
            });
          }, 1500);

        }" :submit-registration="() => {
          log(registration);

          const formName = formsNames.registration;

          if (registration.repeatedPassword !== registration.password) {
            return false;
          };

          const requestOptions = {
            headers: {
              'X-CSRF-Token': $store.state.csrftoken
            }
          };

          $store.commit('authorization/switchRequestingState', true);

          // const request = axios(requestOptions);

          const request = window.Promise.resolve({
            status: 'ok',
            userData: {
              balance: 0,
              name: registration.username,
              avatar: 'None',
              id: 139452
            },
            successMessage: 'Вы успешно прошли регистрацию.'
          });

          window.setTimeout(() => {
            request.then(response => {
              const isError = response.status !== 'ok';
              const responseOptions = {
                userData: {
                  ...response.userData
                },
                errorMessage: isError ? 'Что-то пошло не так.' : '',
                successMessage: response.successMessage,
                isError,
                formName,
              };


              this.$store.dispatch(
                'authorization/notifyAboutSuccesRegistration',
                responseOptions
              );
            });
          }, 1500);


        }">
  </user-authorization>
</header>
<!-- end header -->
